//
//  BostonBuildingClient.swift
//  AsTheCrowFlies
//
//  Created by Joshua Kaden on 1/15/23.
//

import Foundation

final class BostonBuildingClient {
    // https://data.boston.gov/api/3/action/datastore_search_sql?sql=SELECT%20*%20from%20%22391a32e6-d4bb-48d3-a990-cb35a5768a40%22%20WHERE%20%22st_name%22%20%3D%20%27WELLINGTON%20HILL%27%20AND%20%22st_num%22%20%3D%20%2745%27
    //
    
    private let hostAndPath = "https://data.boston.gov/api/3/action/datastore_search_sql"
    private let networkService = NetworkService()
    
    func findBuilding(address: String, postalCode: String, completion: @escaping (BostonBuildingModel?) -> Void) {
        let sqlSelect = "SELECT num_floors, st_name, st_name_suf, st_num, yr_built, zipcode"
        let sqlFrom = "FROM '391a32e6-d4bb-48d3-a990-cb35a5768a40'"
        let sqlWhere = "WHERE CONCAT(st_num, ' ', st_name, ' ', st_name_suf) = '\(address)'"
        let sql = (sqlSelect + " " + sqlFrom + " " + sqlWhere).addingPercentEncoding(withAllowedCharacters: .urlQueryAllowed)!
        
        guard let url = URL(string: hostAndPath + "?sql=" + sql) else {
            print("problem here")
            completion(nil)
            return
        }
        
        networkService.GET(url, httpHeaders: nil) { data, response, error in
            guard let data = data else {
                completion(nil)
                return
            }
            do {
                let model = try JSONDecoder().decode(BostonBuildingModel.self, from: data)
                completion(model)
            } catch {
                print("*** \(error) ***")
                completion(nil)
            }
        }
    }
}


/*
 {"help": "https://data.boston.gov/api/3/action/help_show?name=datastore_search_sql", "success": true, "result": {"records": [{"heat_typ": "W", "total_site_energy_kbtu": null, "ct_pop_med_illness": "1149.59", "dashp_only": "f", "st_name_suf": "ST", "electric_panel_info": null, "hot_water_system_fuel": null, "pid_long": "1405041000", "cashp_only": "f", "lu": "R3", "seal_elevator_vent_shafts": "f", "asbestos": "f", "ct_perc_low_to_no_income": "26.21236133", "ext_fin_list": "W", "historic_district": "f", "ct_pop_children_under_5": "918", "awhp_only": "f", "ext_fin": "W", "last_major_renovation_date": "9/17/2018", "st_num": "45", "hp_recommendation_count": "1", "insulate_exposed_ducts": "f", "ct_perc_over_65": "11.60063391", "use_class": "Residential", "insulation_type": null, "living_area": "5157", "ct_perc_children_under_5": "29.09667195", "num_floors": "3", "st_name": "WELLINGTON HILL", "building_typology": "Multi-Family (3 units)", "perc_gas": null, "ct_perc_poc": "99.08082409", "ct_pop_low_to_no_income": "827", "unit_num": null, "exterior_wall_insulation_at_replacement": "f", "vrf_only": "f", "gshp_only": "f", "ct_pop_poc": "3126", "has_pv": null, "existing_gshp": null, "ct_pop_limited_english_proficiency": "1193", "gross_area": "7556", "interior_wall_insulation_blow_in": "t", "ct_pop_disability": "461", "insulate_exposed_pipes": "t", "existing_ashp": null, "ct_perc_income_200000_or_more": "0", "dashp_outdoor": "f", "dashp_and_elec_upgrade": "t", "ct_perc_disability": "14.61172742", "ct_perc_limited_english_proficiency": "37.81299525", "cm_id": null, "stormwater": "f", "cashp_and_elec_upgrade": "f", "ptype_list": "105", "heating_system_fuel": null, "ext_roof_insulation": "t", "insulate_attic_converted": "f", "heat_typ_list": "W", "ct_hh_income_200000_or_more": "0", "onsite_renewable_kwh": null, "owner_list": "LOPES DAVID P", "yr_built": "1905", "sqft_class": "< 25,000 sqft", "awhp_and_elec_upgrade": "f", "ext_cond_list": "A", "units_mixed": null, "ptype": "105", "own_occ_list": "Y", "assessor_description": "Three-Fam Dwelling", "sqft": "5157", "num_bldgs": "1", "census_tract_number": "25025101101", "exterior_wall_insulation": "f", "r_roof_typ": "F", "own_occ": "Y", "ac": "N", "bldg_styl": "DK", "structure_class": "R", "land_sf": "5916", "lu_list": "R3", "perc_steam": null, "cashp_outdoor": "f", "id": "1", "units_com": null, "ac_list": "N", "bldg_styl_list": "DK", "zipcode": "2126", "flood": "f", "building_subtypology": "Multi-Family (3 units), Pre-1915", "assessor_category": "Residential Property", "structure_class_list": "R", "ct_pop_over_65": "366", "units_res": "3", "ct_perc_med_illness": "36.43708399", "ac_system_type": null, "insulate_spandrel": "f", "insulate_attic": "f", "perc_electricity": null, "env_recommendation_count": "3", "year_built_class": "Pre-1915", "gshp_and_elec_upgrade": "f", "interior_wall_insulation_board": "f", "_full_text": "'-1915':14,20 '0':81,82 '000':17 '1':1,32,95 '105':34,35 '11.60063391':76 '1149.59':73 '1193':71 '14.61172742':74 '1405041000':2 '1905':26 '2126':25 '25':16 '25025101101':66 '26.21236133':77 '29.09667195':75 '3':6,11,31,33,108 '3126':72 '36.43708399':80 '366':69 '37.81299525':78 '45':21 '461':67 '5157':29,30 '5916':27 '7556':28 '827':70 '9/17/2018':65 '918':68 '99.08082409':79 'a':56 'david':47 'dk':51,52 'dwelling':43 'f':53,61,62,63,64,83,84,85,86,88,89,90,91,92,93,94,96,97,99,102,103,104,105,106,107 'fam':42 'family':5,10 'hill':23 'lopes':46 'multi':4,9 'multi-family':3,8 'n':59,60 'p':48 'pre':13,19 'property':39 'r':49,50 'r3':36,37 'residential':15,38 'sqft':18 'st':24 't':87,98,100,101 'three':41 'three-fam':40 'units':7,12 'w':54,55,57,58 'wellington':22 'y':44,45", "foundation_type": null, "existing_shw": null, "landmark": "f", "vrf_and_elec_upgrade": "f", "_id": 41278}], "fields": [{"type": "int4", "id": "_id"}, {"type": "tsvector", "id": "_full_text"}, {"type": "text", "id": "id"}, {"type": "text", "id": "pid_long"}, {"type": "text", "id": "cm_id"}, {"type": "text", "id": "building_typology"}, {"type": "text", "id": "building_subtypology"}, {"type": "text", "id": "use_class"}, {"type": "text", "id": "sqft_class"}, {"type": "text", "id": "year_built_class"}, {"type": "text", "id": "st_num"}, {"type": "text", "id": "st_name"}, {"type": "text", "id": "st_name_suf"}, {"type": "text", "id": "unit_num"}, {"type": "text", "id": "zipcode"}, {"type": "text", "id": "yr_built"}, {"type": "text", "id": "land_sf"}, {"type": "text", "id": "gross_area"}, {"type": "text", "id": "living_area"}, {"type": "text", "id": "sqft"}, {"type": "text", "id": "num_floors"}, {"type": "text", "id": "num_bldgs"}, {"type": "text", "id": "units_res"}, {"type": "text", "id": "units_com"}, {"type": "text", "id": "units_mixed"}, {"type": "text", "id": "ptype"}, {"type": "text", "id": "ptype_list"}, {"type": "text", "id": "lu"}, {"type": "text", "id": "lu_list"}, {"type": "text", "id": "assessor_category"}, {"type": "text", "id": "assessor_description"}, {"type": "text", "id": "own_occ"}, {"type": "text", "id": "own_occ_list"}, {"type": "text", "id": "owner_list"}, {"type": "text", "id": "structure_class"}, {"type": "text", "id": "structure_class_list"}, {"type": "text", "id": "bldg_styl"}, {"type": "text", "id": "bldg_styl_list"}, {"type": "text", "id": "r_roof_typ"}, {"type": "text", "id": "ext_fin"}, {"type": "text", "id": "ext_fin_list"}, {"type": "text", "id": "ext_cond_list"}, {"type": "text", "id": "insulation_type"}, {"type": "text", "id": "foundation_type"}, {"type": "text", "id": "heat_typ"}, {"type": "text", "id": "heat_typ_list"}, {"type": "text", "id": "heating_system_fuel"}, {"type": "text", "id": "ac"}, {"type": "text", "id": "ac_list"}, {"type": "text", "id": "ac_system_type"}, {"type": "text", "id": "hot_water_system_fuel"}, {"type": "text", "id": "electric_panel_info"}, {"type": "text", "id": "has_pv"}, {"type": "text", "id": "existing_ashp"}, {"type": "text", "id": "existing_gshp"}, {"type": "text", "id": "existing_shw"}, {"type": "text", "id": "historic_district"}, {"type": "text", "id": "landmark"}, {"type": "text", "id": "flood"}, {"type": "text", "id": "stormwater"}, {"type": "text", "id": "last_major_renovation_date"}, {"type": "text", "id": "total_site_energy_kbtu"}, {"type": "text", "id": "perc_electricity"}, {"type": "text", "id": "perc_gas"}, {"type": "text", "id": "perc_steam"}, {"type": "text", "id": "onsite_renewable_kwh"}, {"type": "text", "id": "census_tract_number"}, {"type": "text", "id": "ct_pop_disability"}, {"type": "text", "id": "ct_pop_children_under_5"}, {"type": "text", "id": "ct_pop_over_65"}, {"type": "text", "id": "ct_pop_low_to_no_income"}, {"type": "text", "id": "ct_pop_limited_english_proficiency"}, {"type": "text", "id": "ct_pop_poc"}, {"type": "text", "id": "ct_pop_med_illness"}, {"type": "text", "id": "ct_perc_disability"}, {"type": "text", "id": "ct_perc_children_under_5"}, {"type": "text", "id": "ct_perc_over_65"}, {"type": "text", "id": "ct_perc_low_to_no_income"}, {"type": "text", "id": "ct_perc_limited_english_proficiency"}, {"type": "text", "id": "ct_perc_poc"}, {"type": "text", "id": "ct_perc_med_illness"}, {"type": "text", "id": "ct_hh_income_200000_or_more"}, {"type": "text", "id": "ct_perc_income_200000_or_more"}, {"type": "text", "id": "cashp_only"}, {"type": "text", "id": "cashp_and_elec_upgrade"}, {"type": "text", "id": "cashp_outdoor"}, {"type": "text", "id": "dashp_only"}, {"type": "text", "id": "dashp_and_elec_upgrade"}, {"type": "text", "id": "dashp_outdoor"}, {"type": "text", "id": "gshp_only"}, {"type": "text", "id": "gshp_and_elec_upgrade"}, {"type": "text", "id": "vrf_only"}, {"type": "text", "id": "vrf_and_elec_upgrade"}, {"type": "text", "id": "awhp_only"}, {"type": "text", "id": "awhp_and_elec_upgrade"}, {"type": "text", "id": "hp_recommendation_count"}, {"type": "text", "id": "insulate_attic"}, {"type": "text", "id": "insulate_attic_converted"}, {"type": "text", "id": "ext_roof_insulation"}, {"type": "text", "id": "insulate_exposed_ducts"}, {"type": "text", "id": "insulate_exposed_pipes"}, {"type": "text", "id": "interior_wall_insulation_blow_in"}, {"type": "text", "id": "exterior_wall_insulation_at_replacement"}, {"type": "text", "id": "exterior_wall_insulation"}, {"type": "text", "id": "interior_wall_insulation_board"}, {"type": "text", "id": "insulate_spandrel"}, {"type": "text", "id": "asbestos"}, {"type": "text", "id": "seal_elevator_vent_shafts"}, {"type": "text", "id": "env_recommendation_count"}], "sql": "SELECT * from \"391a32e6-d4bb-48d3-a990-cb35a5768a40\" WHERE \"st_name\" = 'WELLINGTON HILL' AND \"st_num\" = '45'"}}
 */
